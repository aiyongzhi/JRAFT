Raft算法中有以下两个核心功能点

1. 主节点如何将数据复制到从节点中，并保证从节点和主节点的数据一致性。
2. 集群高可用：主节点故障探测与主从切换

#### 主从复制

##### 1.增量复制与全量复制

&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;在从节点首次与主节点建立链接的时候，需要进行全量数据复制，
全量复制一般是通过快照机制来实现的。
&nbsp;

&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;当建立起主从复制连接后，主节点在以增量复制的方式将命令传输给主节点。

主从复制可能存在的问题如下，以下问题是需要深度考量的

* 主节点发送数据到从节点中，如果失败了，该怎么办呢？
* 当从节点断线重连的时候，如何尽可能的使用增量复制，而非成本高昂的全量复制？
* 追求高性能的批量异步推送如何实现呢？什么情况下考虑采用批量异步复制？
* 主节点的快照如何生成呢？压缩算法如何考量呢？
* 如何设计可供用户选择的数据一致性？强一致性/过半折衷的一致性/最终一致性

**一定要注意的是，RAFT算法只是分布式共识算法，即让主节点和从节点数据达到一致性的状态，RAFT算法本身并没有强一致性和弱一致性的要求，只是取决于何时给客户端确认？**

---

##### 1.1 主节点发送数据到从节点中，如果失败了，该怎么办呢？

&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;首先根据CAP定理，网络传输过程中，肯定会存在网络波动，导致发生丢包或者延迟现象。
&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;我们可以在从节点接受到主节点的指令时，向主节点回复一个确认，主节点只有收到确认才认为消息发送成功。主节点超时仍然未收到回复，就触发超时重传，达到最大重试次数或者客户端设置的超时时间就向客户端返回操作失败。
&nbsp;

&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;但这样会有个问题，因为分布式系统中，我们要面对丢失关闭，面对重复开放。显然为了保证数据一致性的重传会导致从节点重复接受相同的指令，进而导致从节点和主节点的数据不一致性。所以这里需要保证幂等性。

**总结一下解决方案：**

* 主节点尽最大努力交付：主节点超时重传，重传时间间隔倍增+最大重试次数
* 从节点的定时拉取：从节点定时向主节点汇报自己的复制进度，拉取增量日志记录

**面临的问题：需要保证幂等性**




---

一定要记住，迭代式开发，一个功能一个功能迭代式实现，切记急功近利，不可能一口气吃成个胖子。

